import Fastify, { FastifyInstance } from 'fastify';
import fastifyCors from '@fastify/cors';
import fastifySwagger from '@fastify/swagger';
import healthRoutes from './health/health.route.js';

export default async function buildServer(opts = {}): Promise<FastifyInstance> {
  const app = Fastify({ logger: true });

  // Plugins
  await app.register(fastifyCors, { origin: true });
  await app.register(fastifySwagger, { mode: 'dynamic' });

  // Health routes
  await app.register(healthRoutes, { prefix: '/health' });

  // Application routes (BFF)
  try {
    const routes = await import('./routes/index.js');
    await app.register(routes.default, { prefix: '/' });
  } catch (err) {
    app.log.warn('No routes/index.js found in template');
  }

  app.get('/', async () => ({
    service: '{{serviceName}}',
    status: 'running',
    version: '1.0.0'
  }));

  return app;
}
